<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mapper.cart">

    <!-- 장바구니 정보 매핑: cart_id, goods_isbn, member_id, cart_goods_qty 등 -->
    <resultMap id="cartResult" type="CartVO">
        <!-- goods_id → goods_isbn으로 변경 -->
        <result property="cart_id" column="cart_id"/>
        <result property="goods_isbn" column="goods_isbn"/>
        <result property="member_id" column="member_id"/>
        <result property="cart_goods_qty" column="cart_goods_qty"/>
        <result property="creDate" column="creDate"/>
    </resultMap>
    
    <!-- GoodsVO 매핑 변경 사항 반영 -->
    <!-- goods_id → goods_isbn
         goods_writer → goods_author
         goods_price → goods_priceStandard
         goods_sales_price → goods_priceSales
         goods_fileName → goods_cover -->
    <resultMap id="goodsResult" type="GoodsVO">
        <result property="goods_isbn" column="goods_isbn"/>
        <result property="goods_title" column="goods_title"/>
        <result property="goods_author" column="goods_author"/>
        <result property="goods_priceStandard" column="goods_priceStandard"/>
        <result property="goods_publisher" column="goods_publisher"/>
        <result property="goods_status" column="goods_status"/>
        <result property="goods_priceSales" column="goods_priceSales"/>
        <result property="goods_pubDate" column="goods_pubDate"/>
        <result property="goods_total_page" column="goods_total_page"/>
        <!-- isbn 컬럼명도 변경되었으므로 동일하게 goods_isbn 사용 -->
        <result property="goods_isbn" column="goods_isbn"/>
        <result property="goods_delivery_price" column="goods_delivery_price"/>
        <result property="goods_delivery_date" column="goods_delivery_date"/>
        <result property="goods_cover" column="goods_cover"/>
        <result property="goods_categoryName" column="goods_sort"/>
        <result property="goods_author_intro" column="goods_writer_intro"/>
        <result property="goods_contents_order" column="goods_contents_order"/>
        <result property="goods_intro" column="goods_intro"/>
    </resultMap>

    <!-- 로그인한 회원 아이디로 장바구니 조회 (goods_id → goods_isbn) -->
    <select id="selectCartList" parameterType="cartVO" resultMap="cartResult">
        <![CDATA[
        SELECT cart_id, goods_isbn, member_id, cart_goods_qty, creDate
        FROM T_SHOPPING_CART
        WHERE member_id=#{member_id}
        ORDER BY cart_id DESC
        ]]>
    </select>

    <!-- 장바구니 테이블에 있는 goods_isbn를 이용해 상품정보와 이미지정보 JOIN 조회 -->
    <!-- goods_id 컬럼 → goods_isbn, fileName → goods_cover -->
    <!-- goods_writer → goods_author, goods_price → goods_priceStandard, goods_sales_price → goods_priceSales -->
    <!-- 또한 I.FILENAME → I.goods_cover 로 컬럼명 변경 가정 -->
    <select id="selectGoodsList" resultMap="goodsResult" parameterType="java.util.Map">
        <![CDATA[
        SELECT G.*, I.goods_cover, C.cart_id
        FROM T_SHOPPING_GOODS G
        JOIN T_GOODS_DETAIL_IMAGE I ON G.goods_isbn = I.goods_isbn
        JOIN T_SHOPPING_CART C ON I.goods_isbn = C.goods_isbn
        WHERE I.fileType = 'main_image'
        AND G.goods_isbn IN
        ]]>
        <foreach item="item" collection="list" open="(" separator="," close=")">
            #{item.goods_isbn}
        </foreach>
        <![CDATA[
        ORDER BY C.cart_id DESC
        ]]>
    </select>

    <!-- 장바구니 중복 확인: goods_id → goods_isbn 변경 -->
    <select id="selectCountInCart" resultType="String" parameterType="cartVO">
        <![CDATA[
        SELECT IF(COUNT(*), 'true', 'false') 
        FROM T_SHOPPING_CART
        WHERE goods_isbn=#{goods_isbn}
        AND member_id=#{member_id}
        ]]>
    </select>

    <!-- 장바구니에 상품 추가: goods_id → goods_isbn 변경 -->
    <insert id="insertGoodsInCart" parameterType="cartVO">
        <![CDATA[
        INSERT INTO T_SHOPPING_CART(cart_id, goods_isbn, member_id)
        VALUES(#{cart_id}, #{goods_isbn}, #{member_id})
        ]]>
    </insert>

    <!-- 장바구니 상품 수량 업데이트: goods_id → goods_isbn 변경 -->
    <update id="updateCartGoodsQty" parameterType="cartVO">
        <![CDATA[
        UPDATE T_SHOPPING_CART
        SET cart_goods_qty=#{cart_goods_qty}
        WHERE member_id=#{member_id}
        AND goods_isbn=#{goods_isbn}
        ]]>
    </update>

    <!-- 장바구니 상품 삭제 -->
    <delete id="deleteCartGoods" parameterType="int">
        <![CDATA[
        DELETE FROM T_SHOPPING_CART
        WHERE cart_id=#{cart_id}
        ]]>
    </delete>

    <!-- 장바구니 최대 cart_id 조회 -->
    <select id="selectMaxCartId" resultType="int">
        <![CDATA[
        SELECT IFNULL(MAX(cart_id), 0) + 1 FROM T_SHOPPING_CART
        ]]>
    </select>

</mapper>
