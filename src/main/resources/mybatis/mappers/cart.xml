<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mapper.cart">

    <!-- 장바구니 정보 매핑: cart_id, goods_isbn, member_id, cart_goods_qty 등 -->
    <resultMap id="cartResult" type="CartVO">
        <result property="cart_id" column="cart_id"/>
        <result property="goods_id" column="goods_id"/>
        <result property="member_id" column="member_id"/>
        <result property="cart_goods_qty" column="cart_goods_qty"/>
        <result property="creDate" column="creDate"/>
    </resultMap>
    
    <resultMap id="goodsResult" type="goodsVO">
        <result property="goods_id" column="goods_id" />
        <result property="goods_sort" column="goods_sort" />
        <result property="goods_title" column="goods_title" />
        <result property="goods_writer" column="goods_writer" /> 
        <result property="goods_publisher" column="goods_publisher" />
        <result property="goods_price" column="goods_price" />
  		<result property="goods_sales_price" column="goods_sales_price" />
        <result property="goods_published_date" column="goods_published_date" />
        <result property="goods_total_page" column="goods_total_page" />
        <result property="goods_isbn" column="goods_isbn" />
        <result property="goods_delivery_price" column="goods_delivery_price" />
        <result property="goods_delivery_date" column="goods_delivery_date" />
        <result property="goods_status" column="goods_status" />
        <result property="goods_credate" column="goods_credate" />
        <result property="goods_fileName" column="goods_fileName" />
    </resultMap>

    <!-- 로그인한 회원 아이디로 장바구니 조회 -->
    <select id="selectCartList" parameterType="cartVO" resultMap="cartResult">
        <![CDATA[
        SELECT cart_id, goods_id, member_id, cart_goods_qty, creDate
        FROM t_shopping_cart
        WHERE member_id=#{member_id}
        ORDER BY cart_id DESC
        ]]>
    </select>

    <!-- 장바구니 테이블에 있는 goods_isbn를 이용해 상품정보와 이미지정보 JOIN 조회 -->
    <select id="selectGoodsList" resultMap="goodsResult" parameterType="java.util.Map">
        <![CDATA[
        SELECT G.*, C.cart_id
        FROM t_shopping_goods G
        JOIN t_shopping_cart C ON G.goods_id = C.goods_id
        WHERE G.goods_id IN
        ]]>
        <foreach item="item" collection="list" open="(" separator="," close=")">
            #{item.goods_id}
        </foreach>
        <![CDATA[
        ORDER BY C.cart_id DESC
        ]]>
    </select>

    <!-- 장바구니 중복 확인 -->
    <select id="selectCountInCart" resultType="String" parameterType="cartVO">
        <![CDATA[
        SELECT IF(COUNT(*), 'true', 'false') 
        FROM t_shopping_cart
        WHERE goods_id=#{goods_id}
        AND member_id=#{member_id}
        ]]>
    </select>

    <!-- 장바구니에 상품 추가 -->
    <insert id="insertGoodsInCart" parameterType="cartVO">
        <![CDATA[
        INSERT INTO t_shopping_cart(cart_id, goods_id, member_id, cart_goods_qty)
        VALUES(#{cart_id}, #{goods_id}, #{member_id}, #{cart_goods_qty})
        ]]>
    </insert>

    <!-- 장바구니 상품 수량 업데이트 -->
    <update id="updateCartGoodsQty" parameterType="cartVO">
        <![CDATA[
        UPDATE t_shopping_cart
        SET cart_goods_qty=#{cart_goods_qty}
        WHERE member_id=#{member_id}
        AND goods_id=#{goods_id}
        ]]>
    </update>

    <!-- 장바구니 상품 삭제 -->
    <delete id="deleteCartGoods" parameterType="int">
        <![CDATA[
        DELETE FROM t_shopping_cart
        WHERE cart_id=#{cart_id}
        ]]>
    </delete>

    <!-- 장바구니 최대 cart_id 조회 -->
    <select id="selectMaxCartId" resultType="int">
        <![CDATA[
        SELECT IFNULL(MAX(cart_id), 0) + 1 FROM t_shopping_cart
        ]]>
    </select>

</mapper>
