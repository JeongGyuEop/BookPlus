<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mapper.goods">

    <resultMap id="goodsResult" type="goodsVO">
        <result property="goods_id" column="goods_id" />
        <result property="goods_sort" column="goods_sort" />
        <result property="goods_title" column="goods_title" />
        <result property="goods_writer" column="goods_writer" /> 
        <result property="goods_publisher" column="goods_publisher" />
        <result property="goods_price" column="goods_price" />
  		<result property="goods_sales_price" column="goods_sales_price" />
        <result property="goods_published_date" column="goods_published_date" />
        <result property="goods_total_page" column="goods_total_page" />
        <result property="goods_isbn" column="goods_isbn" />
        <result property="goods_delivery_price" column="goods_delivery_price" />
        <result property="goods_delivery_date" column="goods_delivery_date" />
        <result property="goods_status" column="goods_status" />
        <result property="goods_credate" column="goods_credate" />
        <result property="goods_fileName" column="goods_fileName" />
    </resultMap>

<!--     <resultMap id="imageResult" type="ImageFileVO">
        <result property="goods_id" column="goods_id" />
        <result property="fileName" column="fileName" />
        <result property="reg_id" column="reg_id" />
        <result property="image_id" column="image_id" />
        <result property="fileType" column="fileType" />
    </resultMap> -->

	<select id="selectAllGoods" resultMap="goodsResult">
		SELECT * 
	    FROM T_SHOPPING_GOODS
	    ORDER BY goods_credate DESC
	    LIMIT #{limit} OFFSET #{offset};
	</select>

    <!-- 상품 상세 정보 조회 -->
    <select id="selectGoodsDetail" resultMap="goodsResult" parameterType="String">
        <![CDATA[
        SELECT *
        FROM T_SHOPPING_GOODS
        WHERE goods_id = #{goods_id}
        ]]>
    </select>

    <!-- 상품 상세 이미지 정보 조회 -->
<!--     <select id="selectGoodsDetailImage" resultMap="imageResult" parameterType="String">
        <![CDATA[
        SELECT * 
        FROM T_GOODS_DETAIL_IMAGE 
        WHERE fileType != 'main_image'
        AND goods_id = #{goods_id}
        ]]>
    </select> -->

<!--     상품 검색 (검색어 포함)
    <select id="selectGoodsBySearchWord" resultMap="goodsResult" parameterType="String">
        <![CDATA[
        SELECT g.*, d.fileName 
        FROM T_SHOPPING_GOODS g
        JOIN T_GOODS_DETAIL_IMAGE d ON g.goods_id = d.goods_id
        WHERE d.filetype = 'main_image'
        AND g.goods_title LIKE CONCAT('%', #{searchWord}, '%')
        ORDER BY g.goods_creDate DESC
        ]]>
    </select> -->

    <!-- 키워드 자동 완성 -->
    <select id="selectKeywordSearch" resultType="String" parameterType="String">
        <![CDATA[
        SELECT goods_title 
        FROM T_SHOPPING_GOODS
        WHERE goods_title LIKE CONCAT('%', #{keyword}, '%')
        ORDER BY goods_creDate DESC
    ) t
    LIMIT 15
    ]]>
	</select>

<!--     이미지 파일 정보 삽입
    <insert id="insertNewGoodsImage" parameterType="ImageFileVO">
        <![CDATA[
            INSERT INTO T_GOODS_DETAIL_IMAGE (
            goods_id,
            filename,
            reg_id,
            filetype,
            credate
        ) VALUES (
            #{goods_isbn},
            #{goods_cover},
            #{reg_id},
            #{filetype},
            NOW()
        )
        ]]>
    </insert> -->

	<!-- 상품 상세 정보 조회 -->
	<select id="selectGoodsDetail" resultMap="goodsResult"
		parameterType="String">
        <![CDATA[
        SELECT g.*, d.filename AS fileName
        FROM t_shopping_goods g
        JOIN t_goods_detail_image d ON g.goods_isbn = d.goods_isbn
        WHERE d.filetype = 'main_image'
        AND g.goods_isbn = #{goods_isbn}
        ORDER BY g.goods_isbn
        ]]>
	</select>

	<!-- 상품 상세 이미지 정보 조회 (main_image 제외) 여기서도 GoodsVO의 goods_cover를 사용해서 파일명 
		매핑 -->
	<select id="selectGoodsDetailImage" resultMap="goodsResult"
		parameterType="String">
        <![CDATA[
        SELECT d.goods_isbn, d.filename AS fileName
        FROM t_goods_detail_image d
        WHERE d.filetype != 'main_image'
        AND d.goods_isbn = #{goods_isbn}
        ]]>
	</select>

	<!-- 상품 검색 -->
	<select id="selectGoodsBySearchWord" resultMap="goodsResult"
		parameterType="String">
        <![CDATA[
        SELECT g.*, d.filename AS fileName
        FROM t_shopping_goods g
        JOIN t_goods_detail_image d ON g.goods_isbn = d.goods_isbn
        WHERE d.filetype = 'main_image'
        AND g.goods_title LIKE CONCAT('%', #{searchWord}, '%')
        ORDER BY g.goods_creDate DESC
        ]]>
	</select>

	<!-- 키워드 자동 완성 (변경 사항 없음) -->
	<select id="selectKeywordSearch" resultType="String"
		parameterType="String">
        <![CDATA[
        SELECT goods_title 
        FROM t_shopping_goods
        WHERE goods_title LIKE CONCAT('%', #{keyword}, '%')
        ORDER BY goods_creDate DESC
        ]]>
	</select>
	<!-- ISBN으로 책 조회 -->
    <select id="selectGoodsByISBN" parameterType="string" resultType="GoodsVO">
        SELECT * 
        FROM t_shopping_goods 
        WHERE goods_isbn = #{isbn}
    </select>

    <insert id="insertGoods" parameterType="GoodsVO">
	    INSERT INTO t_shopping_goods (
	        goods_title, 
	        goods_writer, 
	        goods_published_date, 
	        goods_isbn, 
	        goods_price, 
	        goods_sales_price, 
	        goods_fileName
	    ) VALUES (
	        #{goods_title}, 
	        #{goods_writer}, 
	        #{goods_published_date}, 
	        #{goods_isbn}, 
	        #{goods_price}, 
	        #{goods_sales_price}, 
	        #{goods_fileName}
	    )
	</insert>

    <!-- 기존 책 정보 업데이트 -->
    <update id="updateGoods" parameterType="GoodsVO">
        UPDATE t_shopping_goods 
        SET goods_title = #{goods_title},
            goods_writer = #{goods_writer},
            goods_published_date = #{goods_published_date},
            goods_price = #{goods_price},
            goods_sales_price = #{goods_sales_price},
            goods_fileName = #{goods_fileName},
            goods_sort = #{goods_sort},
            goods_publisher = #{goods_publisher}
        WHERE goods_isbn = #{goods_isbn}
    </update>
</mapper>
